<!DOCTYPE html>
<!-- è¢«ä½ å‘ç°äº†å–µ~ Cialloï½(âˆ ãƒ»Ï‰< )âŒ’â˜† -->
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Picture Slicer | å›¾ç‰‡åˆ‡ç‰‡å·¥å…·</title>
    <!-- å¼•å…¥ Google Fonts: Noto Sans SC (æ€æºé»‘ä½“) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@100..900&display=swap" rel="stylesheet">
    <!-- å¼•å…¥ CSS -->
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Cropper.js CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">

    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <!-- è‡ªå®šä¹‰å­—ä½“è®¾ç½® -->
    <style>

        /* å…¨å±€åº”ç”¨å­—ä½“ */
        body {
            font-family: 'Noto Sans SC', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif !important;
        }

        :root {
            --primary-color: #ff9eb5;
            --secondary-color: #a0c4ff;
            --bg-color: #fff0f5;
            --card-bg: #fff;
            --text-color: #555
        }

        [data-theme=sky] {
            --primary-color: #4facfe;
            --secondary-color: #f6d365;
            --bg-color: #e0f2f1;
            --card-bg: #fff
        }

        [data-theme=mint] {
            --primary-color: #00b894;
            --secondary-color: #fdcb6e;
            --bg-color: #f0fdf4;
            --card-bg: #fff
        }

        [data-theme=dark] {
            --primary-color: #bb86fc;
            --secondary-color: #03dac6;
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --text-color: #e0e0e0
        }

        [data-theme=lemon] {
            --primary-color: #f9ca24;
            --secondary-color: #f0932b;
            --bg-color: #fffde7;
            --card-bg: #fff
        }

        [data-theme=grape] {
            --primary-color: #6c5ce7;
            --secondary-color: #a29bfe;
            --bg-color: #f3e5f5;
            --card-bg: #fff
        }

        [data-theme=peach] {
            --primary-color: #ff7675;
            --secondary-color: #fab1a0;
            --bg-color: #fff0e6;
            --card-bg: #fff
        }

        [data-theme=ocean] {
            --primary-color: #0984e3;
            --secondary-color: #74b9ff;
            --bg-color: #e3f2fd;
            --card-bg: #fff
        }

        [data-theme=forest] {
            --primary-color: #218c74;
            --secondary-color: #33d9b2;
            --bg-color: #e8f5e9;
            --card-bg: #fff
        }

        [data-theme=coffee] {
            --primary-color: #cd6133;
            --secondary-color: #d35400;
            --bg-color: #fbeee6;
            --card-bg: #fff
        }

        [data-theme=cyber] {
            --primary-color: #f05;
            --secondary-color: #0fc;
            --bg-color: #050510;
            --card-bg: #101020;
            --text-color: #0fc
        }

        [data-theme=mono] {
            --primary-color: #2d3436;
            --secondary-color: #636e72;
            --bg-color: #f5f6fa;
            --card-bg: #fff
        }

        body {
            background-color: var(--bg-color);
            font-family: Fredoka,Noto Sans SC,sans-serif;
            color: var(--text-color);
            transition: background-color .3s,color .3s;
            display: flex;
            flex-direction: column;
            min-height: 100vh
        }

        .navbar {
            background-color: var(--card-bg);
            box-shadow: 0 4px 15px rgba(0,0,0,.1);
            border-radius: 0 0 var(--border-radius) var(--border-radius);
            transition: background-color .3s
        }

        .navbar-brand {
            font-weight: 700;
            color: var(--primary-color)!important;
            font-size: 1.5rem
        }

        .acg-card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: 0 8px 20px rgba(0,0,0,.05);
            border: 2px solid hsla(0,0%,100%,.1);
            transition: transform .2s,background-color .3s;
            margin-bottom: 20px;
            overflow: hidden
        }

        .acg-header {
            background: linear-gradient(90deg,var(--secondary-color),var(--primary-color));
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center
        }

        .acg-header,.btn-acg {
            color: #fff;
            font-weight: 600
        }

        .btn-acg {
            background-color: var(--primary-color);
            border: none;
            border-radius: 50px;
            padding: 10px 25px;
            box-shadow: 0 4px 10px rgba(0,0,0,.1);
            transition: all .3s
        }

        .btn-acg:hover {
            background-color: var(--secondary-color);
            transform: scale(1.05);
            color: #fff
        }

        #drop-zone {
            border: 3px dashed var(--secondary-color);
            border-radius: var(--border-radius);
            background-color: hsla(0,0%,50%,.05);
            transition: all .3s;
            cursor: pointer;
            min-height: 250px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center
        }

        #drop-zone.dragover {
            border-color: var(--primary-color);
            background-color: rgba(var(--primary-color),.1)
        }

        .img-container {
            max-height: 60vh;
            width: 100%;
            background-color: #333;
            border-radius: var(--border-radius);
            overflow: hidden
        }

        .cropper-view-box {
            display: block;
            overflow: hidden;
            outline: none!important;
            --line-w: 1px;
            --grid-w: 25%;
            --grid-h: 25%;
            --c: #fff
        }

        .cropper-view-box:after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            opacity: 0;
            transition: opacity .2s;
            z-index: 3;
            box-shadow: inset 0 0 0 var(--line-w) var(--c);
            background-image: linear-gradient(90deg,var(--c) var(--line-w),transparent var(--line-w)),linear-gradient(180deg,var(--c) var(--line-w),transparent var(--line-w));
            background-size: var(--grid-w) var(--grid-h);
            background-position: 0 0
        }

        .cropper-view-box.show-grid:after {
            opacity: 1
        }

        .slice-card {
            background: var(--card-bg);
            border: 2px solid transparent;
            border-radius: 12px;
            padding: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,.05);
            text-align: center;
            transition: all .2s;
            position: relative;
            cursor: pointer
        }

        .slice-card.selected {
            border-color: var(--primary-color);
            background-color: rgba(var(--primary-color),.05);
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0,0,0,.1)
        }

        .slice-card .check-mark {
            position: absolute;
            top: 5px;
            left: 5px;
            width: 20px;
            height: 20px;
            background: var(--primary-color);
            color: #fff;
            border-radius: 50%;
            font-size: 12px;
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1
        }

        .slice-card.selected .check-mark {
            display: flex
        }

        .slice-img-wrapper {
            overflow: hidden;
            border-radius: 8px;
            margin-bottom: 8px;
            position: relative
        }

        .slice-card img {
            max-width: 100%;
            height: auto;
            background-image: url('data:image/svg+xml;utf8,<svg width="20" height="20" xmlns="http://www.w3.org/2000/svg"><rect x="0" y="0" width="10" height="10" fill="%23eee"/><rect x="10" y="10" width="10" height="10" fill="%23ccc"/></svg>');
            transition: transform .3s ease
        }

        .slice-card input {
            font-size: .8rem;
            text-align: center;
            border: 1px solid rgba(0,0,0,.1);
            border-radius: 6px;
            background: var(--bg-color);
            color: var(--text-color);
            width: 100%
        }

        #slicePreviewImgContainer:hover img,.slice-img-wrapper:hover img {
            transform: scale(1.5)
        }

        #previewGrid {
            display: grid;
            gap: 10px;
            width: 100%
        }

        #previewGrid>.col {
            width: auto!important;
            flex: none
        }

        .info-icon {
            position: relative;
            cursor: help
        }

        .info-tooltip {
            visibility: hidden;
            width: 200px;
            background-color: rgba(0,0,0,.8);
            color: #fff;
            text-align: left;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 4;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity .3s;
            font-size: .75rem;
            font-weight: 400;
            line-height: 1.2;
            pointer-events: none
        }

        .info-tooltip:after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: 5px;
            border-width: 5px;
            border-style: solid;
            border-color: rgba(0,0,0,.8) transparent transparent
        }

        .info-icon:hover .info-tooltip {
            visibility: visible;
            opacity: 1
        }

        .preset-grid {
            cursor: pointer;
            transition: background-color .2s
        }

        .preset-grid:hover {
            background-color: var(--primary-color)!important
        }

        .nudge-tools {
            display: flex;
            flex-direction: row;
            justify-content: center;
            gap: 2px;
            margin-bottom: 5px;
            opacity: 0;
            transition: .2s
        }

        .slice-card:hover .nudge-tools {
            opacity: 1
        }

        .btn-nudge {
            width: 20px;
            height: 20px;
            padding: 0;
            font-size: 10px;
            line-height: 1;
            border-radius: 4px;
            border: 1px solid #ddd;
            background: #fff;
            color: #555
        }

        .btn-nudge:hover {
            background: var(--primary-color);
            color: #fff;
            border-color: var(--primary-color)
        }

        .btn-preview-slice {
            background: #6c757d;
            color: #fff;
            border: 1px solid #6c757d;
            width: 22px;
            height: 22px;
            padding: 0;
            font-size: 12px;
            line-height: 1;
            border-radius: 4px;
            margin-right: 4px
        }

        .btn-preview-slice:hover {
            background: #5a6268;
            transform: scale(1.1)
        }

        #slicePreviewModal .modal-content {
            background-color: #1a1a1a;
            color: #e0e0e0;
            border: 1px solid #333
        }

        #slicePreviewModal .modal-header {
            border-bottom-color: #333
        }

        #slicePreviewModal .modal-footer {
            border-top-color: #333
        }

        #slicePreviewModal .btn-close {
            filter: invert(1)
        }

        #slicePreviewImgContainer {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 300px;
            background-image: linear-gradient(45deg,#2a2a2a 25%,transparent 0),linear-gradient(-45deg,#2a2a2a 25%,transparent 0),linear-gradient(45deg,transparent 75%,#2a2a2a 0),linear-gradient(-45deg,transparent 75%,#2a2a2a 0);
            background-size: 20px 20px;
            background-position: 0 0,0 10px,10px -10px,-10px 0;
            border-radius: 4px;
            overflow: hidden
        }

        #slicePreviewImg {
            max-width: 100%;
            max-height: 60vh;
            box-shadow: 0 0 20px rgba(0,0,0,.5)
        }

        #modalNudgeTools .btn-nudge {
            width: 30px;
            height: 30px;
            font-size: 14px
        }

        .btn-single-dl {
            position: absolute;
            bottom: 35px;
            right: 5px;
            background: hsla(0,0%,100%,.9);
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-color);
            border: 1px solid #ddd;
            z-index: 2;
            opacity: 0;
            transition: opacity .2s
        }

        .btn-single-dl:hover {
            background: var(--primary-color);
            color: #fff;
            border-color: var(--primary-color)
        }

        .slice-card:hover .btn-single-dl {
            opacity: 1
        }

        footer {
            margin-top: auto;
            padding: 20px 0;
            text-align: center;
            color: var(--text-color);
            font-size: .9rem;
            background-color: var(--card-bg);
            border-top: 1px solid rgba(0,0,0,.05)
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: hsla(0,0%,100%,.8);
            z-index: 5;
            display: none;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(2px)
        }


        /* --- é’ˆå¯¹â€œçº¿æ¡ç²—ç»†â€å’Œâ€œå®¹å·®å€¼â€çš„å¼ºåŠ›æ ·å¼è¦†ç›– --- */

        /* 1. é’ˆå¯¹ Webkit å†…æ ¸æµè§ˆå™¨ (Chrome, Edge, Safari) */
        #inputGridWeight::-webkit-slider-thumb,
        #inputTolerance::-webkit-slider-thumb {
            -webkit-appearance: none; /* ç§»é™¤é»˜è®¤å¤–è§‚ */
            appearance: none;
            background-color: #555555 !important; /* æ»‘å—åœ†ç‚¹ï¼šé»‘è‰² */
            border: 2px solid #555555 !important; /* è¾¹æ¡†ï¼šé»‘è‰² */
            box-shadow: none !important; /* å»æ‰é˜´å½± */
        }

        #inputGridWeight::-webkit-slider-runnable-track,
        #inputTolerance::-webkit-slider-runnable-track {
            background-color: #d6d6d6 !important; /* è½¨é“åº•è‰²ï¼šæ·±ç°è‰² */
        }

        /* 2. é’ˆå¯¹ Firefox æµè§ˆå™¨ */
        #inputGridWeight::-moz-range-thumb,
        #inputTolerance::-moz-range-thumb {
            background-color: #555555 !important;
            border: none !important;
        }

        #inputGridWeight::-moz-range-track,
        #inputTolerance::-moz-range-track {
            background-color: #d6d6d6 !important;
        }

        /* 3. é’ˆå¯¹ IE/Edge æ—§ç‰ˆ */
        #inputGridWeight::-ms-thumb,
        #inputTolerance::-ms-thumb {
            background-color: #555555 !important;
        }

        /* 4. å…³é”®ï¼šå¤„ç†ç‚¹å‡»æ—¶çš„å…‰æ™•é¢œè‰²ï¼ˆFocus Ringï¼‰ */
        /* é˜²æ­¢ç‚¹å‡»æ—¶å‡ºç°åŸæ¥çš„è“è‰²æˆ–ç²‰è‰²å…‰æ™•ï¼Œæ”¹ä¸ºç°è‰²å…‰æ™• */
        #inputGridWeight:focus,
        #inputTolerance:focus {
            border-color: #555555 !important;
            box-shadow: 0 0 0 0.25rem rgba(85, 85, 85, 0.25) !important;
            background-image: none !important; /* ç§»é™¤ Bootstrap å¯èƒ½æ®‹ç•™çš„èƒŒæ™¯å›¾ */
        }

        /* 5. å†æ¬¡å¼ºåˆ¶ä½¿ç”¨ accent-color ä»¥é˜²ä¸‡ä¸€ï¼ˆç°ä»£æµè§ˆå™¨æ”¯æŒï¼‰ */
        #inputGridWeight,
        #inputTolerance {
            accent-color: #555555 !important;
            color: #555555 !important;
        }



        /* =========================================
                èµ›åšæœ‹å…‹ (Cyber) ä¸»é¢˜ä¸“å±ä¿®å¤
        ========================================= */

        /* 1. ä¿®å¤å­—ä½“é¢œè‰²çœ‹ä¸æ¸…çš„é—®é¢˜ */
        /* å¼ºåˆ¶å°† "text-muted" (åŸæœ¬çš„ç°è‰²) æ”¹ä¸ºä¸»é¢˜è‰² (é’è‰²)ï¼Œå¹¶ç¨å¾®é™ä½é€æ˜åº¦ */
        [data-theme="cyber"] .text-muted {
            color: var(--text-color) !important; 
            opacity: 0.9;
        }

        /* 2. ä¿®å¤å¤§é¢ç§¯ç™½è‰²èƒŒæ™¯å—çš„é—®é¢˜ */
        /* å°† .bg-light (åŸæœ¬çš„ç™½è‰²) æ”¹ä¸ºæ·±è‰²åŠé€æ˜èƒŒæ™¯ï¼Œå¹¶åŠ ä¸Šèµ›åšé£è¾¹æ¡† */
        [data-theme="cyber"] .bg-light {
            background-color: rgba(0, 0, 0, 0.3) !important; /* æ·±é»‘è‰²èƒŒæ™¯ */
            border: 1px solid rgba(0, 255, 204, 0.2) !important; /* é’è‰²å¾®å…‰è¾¹æ¡† */
            color: var(--text-color) !important;
        }

        /* 3. (å¯é€‰) ä¼˜åŒ–è¾“å…¥æ¡†æ—è¾¹çš„æ–‡å­—èƒŒæ™¯ (å¦‚ "è¡Œ"ã€"åˆ—"ã€"å®½"ã€"é«˜") */
        [data-theme="cyber"] .input-group-text {
            background-color: rgba(0, 255, 204, 0.1) !important;
            color: var(--text-color) !important;
            border-color: rgba(0, 255, 204, 0.3) !important;
        }

        /* 4. (å¯é€‰) ä¼˜åŒ–è¾“å…¥æ¡†æœ¬èº«çš„èƒŒæ™¯ï¼Œé¿å…å¤ªç™½ */
        [data-theme="cyber"] .form-control, 
        [data-theme="cyber"] .form-select {
            background-color: rgba(0, 0, 0, 0.5) !important;
            color: var(--text-color) !important;
            border-color: rgba(0, 255, 204, 0.3) !important;
        }
        /* ä¿®å¤è¾“å…¥æ¡†å ä½ç¬¦é¢œè‰² */
        [data-theme="cyber"] .form-control::placeholder {
            color: rgba(0, 255, 204, 0.5) !important;
        }


        /* =========================================
        æ‰‹æœºç«¯é€‚é…ä¿®å¤ (Mobile Responsive Fixes)
        ========================================= */
        @media (max-width: 768px) {

            /* --- 1. ä¿®å¤â€œåˆ‡ç‰‡ç»“æœâ€å®¹å™¨ --- */
            #previewGrid {
                /* å¼ºåˆ¶è¦†ç›– JS è®¾ç½®çš„å›ºå®šåˆ—æ•° */
                /* æ‰‹æœºç«¯æ”¹ä¸º 2 åˆ—æ˜¾ç¤ºï¼Œè¿™æ ·å›¾ç‰‡å¤Ÿå¤§ä¸”ä¸ä¼šæº¢å‡º */
                grid-template-columns: repeat(2, 1fr) !important; 
                gap: 8px !important;
            }

            /* è°ƒæ•´å¡ç‰‡å†…è¾¹è·ï¼ŒèŠ‚çœç©ºé—´ */
            .slice-card {
                padding: 5px !important;
            }

            /* --- 2. ä¿®å¤â€œåˆ‡ç‰‡é¢„è§ˆä¸å¾®è°ƒâ€å¼¹çª—åº•éƒ¨ --- */
            /* å°†åº•éƒ¨æ æ”¹ä¸ºå‚ç›´æ’åˆ—ï¼Œé˜²æ­¢æŒ¤å‹ */
            #slicePreviewModal .modal-footer {
                flex-direction: column !important; 
                height: auto !important;
                padding: 15px 10px !important;
                gap: 15px;
            }

            /* (å·¦ä¾§) ä¿¡æ¯ç»Ÿè®¡å—ï¼šæ”¹ä¸ºå±…ä¸­æ¨ªå‘æ’åˆ— */
            #slicePreviewModal .modal-footer > div.text-start {
                padding-left: 0 !important;
                width: 100%;
                text-align: center !important;
                display: flex;
                flex-wrap: wrap;
                justify-content: center;
                gap: 15px;
                min-width: auto !important;
            }
            /* è®©åŸæœ¬ç«–æ’çš„æ–‡å­—åœ¨ä¸€è¡Œæ˜¾ç¤º */
            #slicePreviewModal .modal-footer > div.text-start > div {
                display: inline-block;
                margin-bottom: 0;
            }

            /* (ä¸­é—´) ç¼©æ”¾æ§ä»¶ï¼šå–æ¶ˆç»å¯¹å®šä½ï¼Œè®©å®ƒæµå¼æ’å¸ƒ */
            #slicePreviewModal .modal-footer > div.position-absolute {
                position: static !important; /* å…³é”®ï¼šå–æ¶ˆç»å¯¹å®šä½ */
                transform: none !important;
                margin: 0 !important;
                width: 100%;
                display: flex;
                justify-content: center;
            }

            /* (å³ä¾§) è®¾ç½®æ»‘å—ï¼šå®½åº¦å æ»¡å¹¶å±…ä¸­ */
            #slicePreviewModal .modal-footer > div.d-flex.flex-column {
                padding-right: 0 !important;
                width: 100%;
                align-items: center !important;
                min-width: auto !important;
            }

            /* è°ƒæ•´å…·ä½“è®¾ç½®è¡Œçš„å¯¹é½æ–¹å¼ */
            #slicePreviewModal .modal-footer .d-flex.align-items-center.justify-content-end {
                justify-content: center !important;
                width: 100% !important;
            }
            
            /* å¢åŠ æ»‘å—åŒºåŸŸçš„ç‚¹å‡»é¢ç§¯ */
            #slicePreviewModal .form-range {
                width: 50% !important; /* ç¨å¾®åŠ å®½æ»‘å— */
            }
            
            /* ä¿®å¤å¼¹çª—å†…å›¾ç‰‡å®¹å™¨çš„é«˜åº¦ï¼Œé¿å…æ‰‹æœºä¸Šå¤ªé«˜ */
            #slicePreviewImgContainer {
                height: 40vh !important; 
            }
        }

    </style>
</head>
<body data-theme="">

<!-- åŠ è½½å±‚ -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="text-center">
        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
        <p class="mt-2 fw-bold" style="color: var(--primary-color)">Processing...</p>
    </div>
</div>

<!-- å¯¼èˆªæ  -->
<nav class="navbar navbar-expand-lg sticky-top mb-4">
    <!-- å…³é”®ç‚¹1ï¼šåŠ ä¸Š position-relativeï¼Œä½œä¸ºä¸­é—´æ ‡é¢˜å®šä½çš„çˆ¶å®¹å™¨ -->
    <div class="container position-relative">
        
        <!-- 1. å·¦ä¾§ï¼šæ–°å¢çš„é¦–é¡µæŒ‰é’® -->
        <!-- ä½¿ç”¨ me-auto (margin-end: auto) ä¹Ÿå¯ä»¥ï¼Œä½†åœ¨ flex å¸ƒå±€ä¸‹ç›´æ¥æ”¾ç¬¬ä¸€ä¸ªå°±æ˜¯å·¦è¾¹ -->
        <a class="btn btn-sm btn-outline-secondary rounded-pill" href="https://pengcyril.dpdns.org/">
            <i class="bi bi-house-fill"></i> <span>é¦–é¡µ</span>
        </a>

        <!-- 2. ä¸­é—´ï¼šå›¾ç‰‡åˆ‡ç‰‡å·¥å…· Logo (ç»å¯¹å®šä½å±…ä¸­) -->
        <!-- position-absolute: ç»å¯¹å®šä½ -->
        <!-- top-50 start-50 translate-middle: ç»å…¸çš„ CSS å±…ä¸­å¤§æ³• -->
        <a class="navbar-brand position-absolute top-50 start-50 translate-middle" href="#">
            <i class="bi bi-grid-3x3-gap-fill"></i> 
            <span class="fw-bold">å›¾ç‰‡åˆ‡ç‰‡å·¥å…·</span>
        </a>

        <!-- 3. å³ä¾§ï¼šä¸»é¢˜åˆ‡æ¢ -->
        <!-- å…³é”®ç‚¹2ï¼šåŠ ä¸Š ms-auto (margin-start: auto) æŠŠè¿™ä¸€ç»„å¼ºåˆ¶æ¨åˆ°æœ€å³è¾¹ -->
        <div class="d-flex align-items-center gap-3 ms-auto">
            <!-- ä¸»é¢˜åˆ‡æ¢ -->
            <div class="dropdown">
                <button class="btn btn-sm btn-outline-secondary dropdown-toggle rounded-pill" type="button" data-bs-toggle="dropdown">
                    <i class="bi bi-palette"></i> <span>ä¸»é¢˜</span>
                </button>
                <ul class="dropdown-menu dropdown-menu-end shadow" style="max-height: 600px; overflow-y: auto;">
                    <li><a class="dropdown-item theme-btn" href="#" onclick="changeTheme('')">ğŸŒ¸ æ¨±èŠ±ç²‰ (Sakura)</a></li>
                    <li><a class="dropdown-item theme-btn" href="#" onclick="changeTheme('sky')">â˜ï¸ å¤©ç©ºè“ (Sky)</a></li>
                    <li><a class="dropdown-item theme-btn" href="#" onclick="changeTheme('mint')">ğŸƒ è–„è·ç»¿ (Mint)</a></li>
                    <li><a class="dropdown-item theme-btn" href="#" onclick="changeTheme('dark')">ğŸŒ™ æš—å¤œç´« (Dark)</a></li>
                    <li><a class="dropdown-item theme-btn" href="#" onclick="changeTheme('lemon')">ğŸ‹ æŸ æª¬é»„ (Lemon)</a></li>
                    <li><a class="dropdown-item theme-btn" href="#" onclick="changeTheme('grape')">ğŸ‡ è‘¡è„ç´« (Grape)</a></li>
                    <li><a class="dropdown-item theme-btn" href="#" onclick="changeTheme('peach')">ğŸ‘ èœœæ¡ƒç²‰ (Peach)</a></li>
                    <li><a class="dropdown-item theme-btn" href="#" onclick="changeTheme('ocean')">ğŸŒŠ æ·±æµ·è“ (Ocean)</a></li>
                    <li><a class="dropdown-item theme-btn" href="#" onclick="changeTheme('forest')">ğŸŒ² æ£®æ—ç»¿ (Forest)</a></li>
                    <li><a class="dropdown-item theme-btn" href="#" onclick="changeTheme('coffee')">â˜• å’–å•¡è‰² (Coffee)</a></li>
                    <li><a class="dropdown-item theme-btn" href="#" onclick="changeTheme('cyber')">ğŸ¤– èµ›åšæœ‹å…‹ (Cyber)</a></li>
                    <li><a class="dropdown-item theme-btn" href="#" onclick="changeTheme('mono')">ğŸ¹ æç®€é»‘ç™½ (Mono)</a></li>
                </ul>
            </div>
        </div>
    </div>
</nav>

<div class="container">
    
    <!-- 1. è®¾ç½®åŒºåŸŸ -->
    <div class="row">
        <!-- ä¸Šä¼ ä¸å›¾åƒåŒºåŸŸ -->
        <div class="col-lg-8">
            <div class="acg-card p-0">
                <div class="acg-header">
                    <span>å›¾ç‰‡ç¼–è¾‘åŒº</span>
                    <button class="btn btn-sm btn-light text-primary fw-bold rounded-pill" id="btnReupload" style="display:none;">
                        <i class="bi bi-arrow-counterclockwise"></i> <span>é‡æ–°ä¸Šä¼ </span>
                    </button>
                </div>
                <div class="p-3">
                    <!-- ä¸Šä¼ æ§ä»¶ -->
                    <div id="drop-zone" class="mb-3">
                        <div class="text-center p-4">
                            <i class="bi bi-cloud-arrow-up" style="font-size: 4rem; color: var(--secondary-color);"></i>
                            <p class="mb-2 fw-bold fs-5 mt-3">æ‹–æ‹½å›¾ç‰‡ / Ctrl+V ç²˜è´´ / ç‚¹å‡»ä¸Šä¼ </p>
                            <p class="text-muted small">æ”¯æŒ PNG, JPG, WEBP (å»ºè®® 4K åˆ†è¾¨ç‡)</p>
                            <input type="file" id="fileInput" accept="image/*" class="d-none">
                            <button class="btn btn-acg mt-2" onclick="$('#fileInput').click()">é€‰æ‹©æ–‡ä»¶</button>
                        </div>
                    </div>
                    
                    <!-- Cropper ç¼–è¾‘å™¨ -->
                    <div class="img-container" id="editorContainer" style="display:none;">
                        <img id="image" src="" alt="Picture">
                    </div>
                </div>
            </div>
        </div>

        <!-- æ§åˆ¶é¢æ¿ -->
        <div class="col-lg-4">
            <div class="acg-card p-0">
                <div class="acg-header">
                    <span><i class="bi bi-sliders"></i> <span>åˆ‡ç‰‡è®¾ç½®</span></span>
                </div>
                <div class="p-3">
                    
                    <!-- è¡Œåˆ—è®¾ç½® -->
                    <div class="mb-3">
                        <label class="form-label fw-bold d-flex justify-content-between">
                            <span>ç½‘æ ¼å¸ƒå±€</span> 
                            <span class="badge bg-secondary" id="gridDisplay">4 x 6</span>
                        </label>
                        <div class="input-group">
                            <span class="input-group-text bg-light">è¡Œ</span>
                            <input type="number" class="form-control" id="inputRows" value="4" min="1" max="20">
                            <span class="input-group-text bg-light">åˆ—</span>
                            <input type="number" class="form-control" id="inputCols" value="6" min="1" max="20">
                        </div>
                        <div class="d-flex flex-wrap gap-2 mt-2">
                            <span class="badge bg-secondary preset-grid" data-rows="2" data-cols="2">2x2</span>
                            <span class="badge bg-secondary preset-grid" data-rows="3" data-cols="3">3x3</span>
                            <span class="badge bg-secondary preset-grid" data-rows="4" data-cols="3">4x3</span>
                            <span class="badge bg-secondary preset-grid" data-rows="4" data-cols="4">4x4</span>
                            <span class="badge bg-secondary preset-grid" data-rows="4" data-cols="6">4x6</span>
                            <span class="badge bg-secondary preset-grid" data-rows="5" data-cols="5">5x5</span>
                        </div>
                    </div>
                    
                    <!-- ç½‘æ ¼å¼€å…³ -->
                    <div class="form-check form-switch mb-1">
                        <input class="form-check-input" type="checkbox" id="checkShowGrid" checked>
                        <label class="form-check-label small" for="checkShowGrid">æ˜¾ç¤ºç½‘æ ¼é¢„è§ˆ</label>
                    </div>
                    <div class="row g-2 mt-1 align-items-center">
                        <div class="col-6">
                            <label class="form-label small mb-0 text-muted">ç½‘æ ¼é¢œè‰²</label>
                            <input type="color" class="form-control form-control-color form-control-sm" id="inputGridColor" value="#000000" title="Choose grid color">
                        </div>
                        <div class="col-6">
                            <label class="form-label small text-muted mb-1">çº¿æ¡ç²—ç»†</label>
                            <div class="d-flex align-items-center">
                                <input type="range" class="form-range form-range-sm me-2" id="inputGridWeight" min="1" max="10" value="1">
                            </div>
                        </div>
                    </div>
                    <hr class="my-3 opacity-25">
                    
                    <!-- æŠ å›¾ä¸ç½‘æ ¼ -->
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span>
                                <label class="form-label fw-bold mb-0">æŠ å›¾è®¾ç½®</label>
                                <span class="info-icon ms-1">
                                    <i class="bi bi-info-circle text-warning"></i>
                                    <span class="info-tooltip">æ­¤åŠŸèƒ½ä»…é€‚ç”¨äºçº¯è‰²èƒŒæ™¯ã€‚å¦‚éœ€å®Œç¾å»é™¤å¤æ‚èƒŒæ™¯ï¼Œè¯·å…ˆä½¿ç”¨ä¸“é—¨çš„ AI å·¥å…·å¤„ç†ã€‚</span>
                                </span>
                            </span>
                        </div>

                        <div class="form-check form-switch mb-2">
                            <input class="form-check-input" type="checkbox" id="checkRemoveBg" checked>
                            <label class="form-check-label" for="checkRemoveBg">å¯ç”¨è‡ªåŠ¨æŠ å›¾</label>
                        </div>

                        <div id="bgSettingsPanel" class="bg-light p-2 rounded">
                            <!-- èƒŒæ™¯è‰²ä¸æ¨¡å¼ -->
                            <div class="d-flex align-items-center justify-content-between mb-2">
                                <div>
                                    <label class="form-label small text-muted mb-0">èƒŒæ™¯é¢œè‰²</label>
                                    <i class="bi bi-info-circle text-warning small ms-1 info-icon">
                                        <span class="info-tooltip">å‹¾é€‰è¿ç»­åŒºåŸŸï¼šä»…å»é™¤ä¸è¾¹ç¼˜ç›¸è¿çš„èƒŒæ™¯ï¼ˆä¿æŠ¤çœ¼ç›/è¡£æœç­‰å†…éƒ¨é¢œè‰²ï¼‰ã€‚<br>ä¸å‹¾é€‰ï¼šå»é™¤ç”»é¢ä¸­æ‰€æœ‰ä¸èƒŒæ™¯è‰²ç›¸åŒçš„åƒç´ ã€‚</span>
                                    </i>
                                    <div class="input-group input-group-sm mt-1" style="width: 130px;">
                                        <button class="btn btn-outline-secondary w-100 d-flex align-items-center justify-content-center" type="button" id="btnPickColor" title="ç‚¹å‡»å¸å–é¢œè‰²">
                                            <div id="pickedColorPreview" style="width: 15px; height: 15px; background: #ffffff; border: 1px solid #999; margin-right: 8px;"></div>
                                            <i class="bi bi-eyedropper"></i>
                                        </button>
                                    </div>
                                    <!-- éšè—çš„åŸç”Ÿå–è‰²å™¨ -->
                                    <input type="color" id="nativeColorInput" value="#ffffff" style="visibility: hidden; position: absolute;">
                                </div>
                                
                                <div class="form-check form-switch mt-3 me-2">
                                    <input class="form-check-input" type="checkbox" id="checkBgContiguous" checked="">
                                    <label class="form-check-label small" for="checkBgContiguous">ä»…è¿ç»­åŒºåŸŸ (ä¿æŠ¤å†…éƒ¨)</label>
                                </div>
                            </div>
                        
                            <!-- å®¹å·®å€¼ -->
                            <label class="form-label d-flex justify-content-between small text-muted align-items-center mt-1">
                                <span>å®¹å·®å€¼</span>
                                <!-- åªæœ‰è¿™ä¸€ä¸ª id="toleranceVal" çš„ input -->
                                <input type="number" id="toleranceVal" class="form-control form-control-sm p-0 text-center" 
                                    style="width: 50px; height: 24px; border: 1px solid #ced4da;" 
                                    value="5" min="0" max="100">
                            </label>
                            <input type="range" class="form-range" id="inputTolerance" min="0" max="100" value="5">
                        </div>

                    <!-- æ ¼å¼ä¸è´¨é‡ -->
                    <div class="mb-3 mt-3">
                        <span>
                            <label class="form-label fw-bold">è¾“å‡ºæ ¼å¼</label>
                            <span class="info-icon ms-1">
                                <i class="bi bi-info-circle text-warning"></i>
                                <span class="info-tooltip">å¦‚æœä½ æƒ³åœ¨å¾®ä¿¡é‡Œä½¿ç”¨ï¼Œæœ€ç®€å•çš„æ–¹æ³•æ˜¯ç›´æ¥æ”¹pngåç¼€åä¸ºgif</span>
                            </span>
                        </span>
                        <div class="row g-2">
                            <div class="col-6">
                                <select class="form-select form-select-sm" id="formatSelect">
                                    <option value="image/png">PNG (é€æ˜ç”»è´¨)</option>
                                    <option value="image/webp">WEBP (ä½“ç§¯å°å·§)</option>
                                </select>
                            </div>
                            <div class="col-6" id="qualityBox" style="display:none;">
                                <div class="input-group input-group-sm">
                                    <span class="input-group-text">Q</span>
                                    <input type="number" class="form-control" id="qualityInput" value="0.9" min="0.1" max="1.0" step="0.1">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="output-resize-options">
                        <div class="row g-2">   
                            <div class="col-6 form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="checkMakeSquare">
                                <label class="form-check-label small" for="checkMakeSquare">ç»Ÿä¸€è½¬ä¸ºæ­£æ–¹å½¢</label>
                            </div>
                        
                            <div class="col-6 form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="checkCustomSize">
                                <label class="form-check-label small" for="checkCustomSize">è‡ªå®šä¹‰è¾“å‡ºå°ºå¯¸ï¼ˆåƒç´ ï¼‰</label>
                            </div>
                        </div>
                        <div id="customSizePanel" class="input-group input-group-sm" style="display: none;">
                            <span class="input-group-text">å®½</span>
                            <input type="number" class="form-control" id="outputWidth" placeholder="ä¾‹å¦‚ 240">
                            <span class="input-group-text">é«˜</span>
                            <input type="number" class="form-control" id="outputHeight" placeholder="ä¾‹å¦‚ 240">
                        </div>
                   
                        <p class="text-muted small mt-1">
                            <span>åŸå§‹åˆ‡ç‰‡å°ºå¯¸:</span>
                            <span id="squareDimDisplay" class="fw-bold">N/A</span>
                        </p>
                    </div>
                    
                    <!-- åŠ¨ä½œæŒ‰é’® -->
                    <div class="d-grid gap-2 mt-3">
                        <button class="btn btn-acg btn-lg" id="btnSlice">
                            <i class="bi bi-lightning-charge-fill"></i> <span>ä¸€é”®ç”Ÿæˆåˆ‡ç‰‡</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        </div>
    </div>

    <!-- 2. ç»“æœé¢„è§ˆåŒºåŸŸ -->
    <div class="row mt-4" id="resultSection" style="display:none;">
        <div class="col-12">
            <div class="acg-card p-0">
                <div class="acg-header">
                    <span>
                        <i class="bi bi-images"></i> <span>åˆ‡ç‰‡ç»“æœ</span> 
                        <span class="badge bg-light text-dark ms-2" id="resultCount">0</span>
                    </span>
                    <div>
                        <button class="btn btn-light text-primary btn-sm fw-bold rounded-pill" id="btnSelectAll">
                            <i class="bi bi-check-all"></i> <span>å…¨é€‰</span>
                        </button>
                        <button class="btn btn-light text-primary btn-sm fw-bold rounded-pill ms-2" id="btnDownloadZip">
                            <i class="bi bi-file-earmark-zip-fill"></i> <span>æ‰“åŒ…ä¸‹è½½</span>
                        </button>
                    </div>
                </div>
                <div class="p-4" style="background-color: var(--bg-color);">
                    <p class="text-muted text-center small mb-3">
                        <i class="bi bi-hand-index-thumb"></i> <span>ç‚¹å‡»é€‰ä¸­ | æ‚¬åœæŒ‰é’®å¾®è°ƒ (ç§»åŠ¨/ç¼©æ”¾/æ™ºèƒ½å±…ä¸­) | å³ä¸‹è§’å•å›¾ä¸‹è½½</span>
                    </p>
                    <!-- ç½‘æ ¼å±•ç¤º -->
                    <div class="" id="previewGrid"> 
                        <!-- JS åŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- é¡µè„š -->
<footer>
    <div class="container">
        <p class="mb-1">Â© 2025 Picture Slicer Tool. All rights reserved.</p>
        <p class="mb-0 text-muted opacity-75">
            <i class="bi bi-shield-lock-fill"></i> 
            <span>æœ¬å·¥å…·æ‰€æœ‰å¤„ç†å‡åœ¨æœ¬åœ°æµè§ˆå™¨å®Œæˆï¼Œæ‚¨çš„å›¾ç‰‡ä¸ä¼šä¸Šä¼ è‡³æœåŠ¡å™¨ï¼Œè¯·æ”¾å¿ƒä½¿ç”¨ã€‚</span>
        </p>
    </div>
</footer>

<!-- é¢„è§ˆä¸å¾®è°ƒå¼¹çª— (ä¿®æ­£ä½ç½®) -->
<div class="modal fade" id="slicePreviewModal" tabindex="-1" aria-hidden="true">
    <!-- å¼¹çª—å†…å®¹ç”±JSåŠ¨æ€æ³¨å…¥/æ§åˆ¶ -->
</div>

<!-- è„šæœ¬å¼•å…¥ (ç›¸å¯¹è·¯å¾„) -->
<script src="../../assets/js/jquery.min.js"></script>
<script src="../../assets/js/bootstrap.bundle.min.js"></script>
<script src="../../assets/js/cropper.min.js"></script>
<script src="../../assets/js/jszip.min.js"></script>
<script src="../../assets/js/FileSaver.min.js"></script>
<script>
const state = {
    theme: localStorage.getItem("ps_theme") || "",
    rows: parseInt(localStorage.getItem("ps_rows")) || 4,
    cols: parseInt(localStorage.getItem("ps_cols")) || 6,
    tolerance: parseInt(localStorage.getItem("ps_tolerance")) || 5,
    cropper: null,
    fileName: "slice",
    baseSliceW: 0,
    baseSliceH: 0,
    sourceCanvas: null,
    slicedImages: [],
    bgContiguous: !0,
    targetColor: {
        r: 255,
        g: 255,
        b: 255
    },
    isPicking: !1,
    activePreviewIdx: -1
},
// ç§»é™¤äº†è‹±æ–‡åŒ…ï¼Œå°†ä¸­æ–‡æ–‡æœ¬ä¿ç•™ä¸ºå¸¸é‡ä¾›JSåŠ¨æ€è°ƒç”¨
TEXT = {
    error_no_img: "è¯·å…ˆä¸Šä¼ ä¸€å¼ å›¾ç‰‡å“¦ï¼",
    zip_generating: "æ­£åœ¨æ‰“åŒ…...",
    download_ready: "ä¸‹è½½å³å°†å¼€å§‹!",
    msg_selected_dl: "ä¸‹è½½é€‰ä¸­",
    msg_all_dl: "ä¸‹è½½å…¨éƒ¨",
    btn_download_zip: "æ‰“åŒ…ä¸‹è½½"
};

function injectCustomDOM() {
    $("#slicePreviewModal").remove();
    $("body").append(`
    <div class="modal fade" id="slicePreviewModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg" style="max-width: 90vw;">
            <div class="modal-content">
                <!-- å¤´éƒ¨ -->
                <div class="modal-header py-2 bg-dark border-bottom border-secondary position-relative justify-content-center">
                    <h5 class="modal-title fs-6 text-white w-100 text-center">åˆ‡ç‰‡é¢„è§ˆä¸å¾®è°ƒ</h5>
                    <button type="button" class="btn-close btn-close-white position-absolute end-0 me-3" data-bs-dismiss="modal"></button>
                </div>
                
                <!-- å›¾ç‰‡ä¸»ä½“ -->
                <div class="modal-body text-center p-0" style="background:#1a1a1a; position:relative; overflow:hidden;">
                    <div id="slicePreviewImgContainer" class="d-flex align-items-center justify-content-center" 
                         style="height: 50vh; background-image: linear-gradient(45deg, #333 25%, transparent 25%), linear-gradient(-45deg, #333 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #333 75%), linear-gradient(-45deg, transparent 75%, #333 75%); background-size: 20px 20px; overflow: hidden; cursor: grab;">
                        <img id="slicePreviewImg" src="" style="max-width: 100%; max-height: 100%; object-fit: contain; box-shadow: 0 0 20px rgba(0,0,0,0.5); transform-origin: center center;">
                    </div>
                </div>
                
                <!-- åº•éƒ¨æ§åˆ¶æ  -->
                <div class="modal-footer py-2 bg-dark border-top border-secondary d-flex align-items-center justify-content-between position-relative" style="min-height: 80px;">
                    
                    <!-- 1. å·¦ä¾§ï¼šè¯¦ç»†ä¿¡æ¯ -->
                    <div class="text-start d-flex flex-column justify-content-center ps-5" style="font-family: monospace; line-height: 1.6; min-width: 200px; z-index: 1;">
                        <div><span class="text-white">åŸå›¾: </span><span id="modalOrigDim" class="text-white-50 ms-2">-</span></div>
                        <div><span class="text-white">è¾“å‡º: </span><span id="modalCurrDim" class="text-warning ms-2">-</span></div>
                        <div><span class="text-white">é¢„ä¼°: </span><span id="modalFileSize" class="text-info ms-2">-</span> <span class="text-white-50">KB</span></div>
                    </div>
                    
                    <!-- 2. ä¸­é—´ï¼šè§†å›¾ç¼©æ”¾ -->
                    <div class="position-absolute top-50 start-50 translate-middle" style="z-index: 10;">
                        <div class="input-group input-group-sm justify-content-center shadow-sm" style="width: 160px;">
                            <button class="btn btn-outline-secondary text-light border-secondary" id="btnViewZoomOut" title="ç¼©å°è§†å›¾"><i class="bi bi-dash-lg"></i></button>
                            <input type="number" id="inputViewZoom" class="form-control bg-dark text-white border-secondary" 
                                   style="text-align: center; padding-left: 5px; padding-right: 0;" 
                                   value="100" min="10" max="500" step="10">
                            <span class="input-group-text bg-dark text-white border-secondary border-start-0 px-2" style="font-size:0.8rem;">%</span>
                            <button class="btn btn-outline-secondary text-light border-secondary" id="btnViewZoomIn" title="æ”¾å¤§è§†å›¾"><i class="bi bi-plus-lg"></i></button>
                        </div>
                    </div>

                    <!-- 3. å³ä¾§ï¼šè®¾ç½® -->
                    <div class="d-flex flex-column align-items-end justify-content-center gap-2 pe-5" style="min-width: 200px; z-index: 1;">
                        
                        <!-- å®¹å·®è¡Œ -->
                        <div class="d-flex align-items-center justify-content-end text-light small" style="width: 100%;">
                            <label class="me-2 text-white text-end" style="width: 40px;">å®¹å·®</label>
                            <input type="range" class="form-range" id="modalToleranceInput" min="0" max="100" style="width: 100px;">
                            <input type="number" id="modalToleranceVal" class="form-control form-control-sm bg-dark text-white border-secondary ms-2" 
                                   style="width: 55px; text-align: center; padding: 0 4px;" value="5" min="0" max="100">
                        </div>

                        <!-- è¿ç»­è¡Œ -->
                        <div class="d-flex align-items-center justify-content-end text-light small" style="width: 100%;">
                            <label class="me-2 text-white text-end" style="width: 40px;" for="modalContiguousInput">è¿ç»­</label>
                            <div class="d-flex align-items-center justify-content-start" style="width: 100px;">
                                <div class="form-check form-switch mb-0 ms-1" style="min-height: unset; padding-left: 2.5em;">
                                    <input class="form-check-input cursor-pointer" type="checkbox" id="modalContiguousInput" 
                                           style="margin-top: 0; cursor: pointer;">
                                </div>
                            </div>
                            <span class="ms-2" style="width: 55px;"></span>
                        </div>

                    </div>
                </div>

                <!-- åº•éƒ¨å¾®è°ƒæŒ‰é’®åŒº -->
                <div class="row py-2 bg-dark border-top border-secondary g-0">
                    <div class="col-12 d-flex justify-content-center">
                        <div id="modalNudgeTools" class="d-flex gap-2"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>`);
    
    const e = $("#bgSettingsPanel .col-12");
    e.length && (e.empty(),
    e.append('\n            <div class="d-flex align-items-center justify-content-between mb-2">\n                <div>\n                    <label class="form-label small text-muted mb-0">èƒŒæ™¯é¢œè‰²</label>\n                    <div class="input-group input-group-sm mt-1" style="width: 140px;">\n                        <button class="btn btn-outline-secondary w-100 d-flex align-items-center justify-content-center" type="button" id="btnPickColor">\n                            <div id="pickedColorPreview" style="width: 15px; height: 15px; background: #ffffff; border: 1px solid #999; margin-right: 8px;"></div>\n                            <i class="bi bi-eyedropper"></i>\n                        </button>\n                    </div>\n                    <input type="color" id="nativeColorInput" value="#ffffff" style="visibility: hidden; position: absolute;">\n                </div>\n                <div class="form-check form-switch">\n                    <input class="form-check-input" type="checkbox" id="checkBgContiguous" checked>\n                    <label class="form-check-label small" for="checkBgContiguous">ä»…è¿ç»­åŒºåŸŸ</label>\n                </div>\n            </div>\n        '))
}

function initUI() {
    $("#inputRows").val(state.rows);
    $("#inputCols").val(state.cols);
    $("#inputTolerance").val(state.tolerance);
    $("#toleranceVal").val(state.tolerance); 
    $("#bgSettingsPanel").toggle($("#checkRemoveBg").is(":checked"));
    
    const e = "#" + [state.targetColor.r, state.targetColor.g, state.targetColor.b]
        .map(e => e.toString(16).padStart(2, "0")).join("");
    $("#pickedColorPreview").css("background-color", e);
    $("#nativeColorInput").val(e);
}

function changeTheme(e) {
    state.theme = e,
    localStorage.setItem("ps_theme", e),
    $("body").attr("data-theme", e)
}

function bindEvents() {
    $("#formatSelect").change(function() {
        "image/webp" === $(this).val() ? $("#qualityBox").show() : $("#qualityBox").hide();
    });

    const e = $("#drop-zone");
    e.on("dragover", t => {
        t.preventDefault();
        e.addClass("dragover");
    });
    e.on("dragleave", () => e.removeClass("dragover"));
    e.on("drop", t => {
        t.preventDefault();
        e.removeClass("dragover");
        t.originalEvent.dataTransfer.files.length && handleFile(t.originalEvent.dataTransfer.files[0]);
    });

    $("#fileInput").on("change", e => {
        e.target.files.length && handleFile(e.target.files[0]);
    });

    $("#btnReupload").click(() => {
        state.cropper && state.cropper.destroy();
        $("#editorContainer").hide();
        $("#drop-zone").show();
        $("#btnReupload").hide();
        $("#resultSection").hide();
        $("#fileInput").val("");
    });

    document.addEventListener("paste", function(e) {
        const t = (e.clipboardData || e.originalEvent.clipboardData).items;
        for (let a = 0; a < t.length; a++) {
            const n = t[a];
            if ("file" === n.kind && n.type.startsWith("image/")) {
                handleFile(n.getAsFile());
                e.preventDefault();
                break;
            }
        }
    });

    $("#inputRows, #inputCols").on("input change", function() {
        state.rows = Math.max(1, $("#inputRows").val());
        state.cols = Math.max(1, $("#inputCols").val());
        $("#gridDisplay").text(`${state.rows} x ${state.cols}`);
        localStorage.setItem("ps_rows", state.rows);
        localStorage.setItem("ps_cols", state.cols);
        updateCropperGrid();
        updateSquareDimDisplay();
    });

    $("#inputTolerance").on("input", function() {
        state.tolerance = parseInt($(this).val());
        $("#toleranceVal").val(state.tolerance);
        localStorage.setItem("ps_tolerance", state.tolerance);
    });

    $("#toleranceVal").on("input change", function() {
        let val = parseInt($(this).val());
        if (isNaN(val)) val = 0;
        if (val < 0) val = 0;
        if (val > 100) val = 100;
        state.tolerance = val;
        $("#inputTolerance").val(val);
        localStorage.setItem("ps_tolerance", state.tolerance);
    });

    $(document).on("change", "#checkBgContiguous", function() {
        state.bgContiguous = $(this).is(":checked");
    });

    $("#checkRemoveBg").on("change", function() {
        $("#bgSettingsPanel").toggle($(this).is(":checked"));
    });

    $(document).on("click", "#btnPickColor", function() {
        $("#nativeColorInput").click();
    });

    $("#checkShowGrid").on("change", function() {
        updateCropperGrid();
    });

    $("#inputGridWeight, #inputGridColor").on("input", updateCropperGrid);

    $("#formatSelect").change(function() {
        const e = $(this).val();
        $("#qualityBox").toggle("image/webp" === e);
    });

    $("#btnSlice").click(generateSlices);
    $("#btnSelectAll").click(toggleSelectAll);
    $("#btnDownloadZip").click(downloadZip);

    $(".preset-grid").click(function() {
        const e = $(this).data("rows"),
            t = $(this).data("cols");
        $("#inputRows").val(e).trigger("change");
        $("#inputCols").val(t).trigger("change");
    });

    $("#checkCustomSize").change(function() {
        const e = $(this).is(":checked");
        $("#customSizePanel").toggle(e);
        e && $("#checkMakeSquare").prop("checked", !1);
    });

    $("#checkMakeSquare").change(function() {
        $(this).is(":checked") && ($("#checkCustomSize").prop("checked", !1),
            $("#customSizePanel").hide());
    });

    $("#slicePreviewImgContainer").on("wheel", function(e) {
        if (e.preventDefault(), -1 === state.activePreviewIdx) return;
        const t = e.originalEvent.deltaY < 0 ? .05 : -.05;
        zoom(state.activePreviewIdx, t);
    });

    $(document).on("input change", "#nativeColorInput", function() {
        const e = $(this).val();
        $("#pickedColorPreview").css("background-color", e);
        const t = parseInt(e.slice(1, 3), 16),
            a = parseInt(e.slice(3, 5), 16),
            n = parseInt(e.slice(5, 7), 16);
        state.targetColor = { r: t, g: a, b: n };
    });

    // ç¼©æ”¾é€»è¾‘
    let t = 1;
    function a() {
        $("#slicePreviewImg").css("transform", `scale(${t})`);
        $("#inputViewZoom").val(Math.round(100 * t));
    }

    $(document).on("wheel", "#slicePreviewImgContainer", function(e) {
        if (-1 === state.activePreviewIdx) return;
        e.preventDefault();
        const n = e.originalEvent.deltaY;
        t = n < 0 ? Math.min(t + .1, 5) : Math.max(t - .1, .1);
        a();
    });

    $(document).on("click", "#btnViewZoomIn", () => {
        t = Math.min(t + .1, 5);
        a();
    });

    $(document).on("click", "#btnViewZoomOut", () => {
        t = Math.max(t - .1, .1);
        a();
    });

    $(document).on("change input", "#inputViewZoom", function() {
        let val = parseFloat($(this).val());
        if (isNaN(val) || val < 10) val = 10;   
        if (val > 500) val = 500;              
        t = val / 100;
        $("#slicePreviewImg").css("transform", `scale(${t})`);
    });

    $(document).on("input", "#modalToleranceInput", function() {
        const e = $(this).val();
        $("#modalToleranceVal").val(e);
        state.tolerance = parseInt(e);
        $("#inputTolerance").val(e);
        $("#toleranceVal").val(e);
        if (-1 !== state.activePreviewIdx) {
            processSingleSlice(state.slicedImages[state.activePreviewIdx]);
        }
    });

    $(document).on("input change", "#modalToleranceVal", function() {
        let val = parseInt($(this).val());
        if (isNaN(val)) val = 0;
        if (val < 0) val = 0;
        if (val > 100) val = 100;
        $(this).val(val);
        $("#modalToleranceInput").val(val);
        state.tolerance = val;
        $("#inputTolerance").val(val);
        $("#toleranceVal").val(val);
        if (-1 !== state.activePreviewIdx) {
            processSingleSlice(state.slicedImages[state.activePreviewIdx]);
        }
    });

    $(document).on("change", "#modalContiguousInput", function() {
        const e = $(this).is(":checked");
        state.bgContiguous = e;
        $("#checkBgContiguous").prop("checked", e);
        -1 !== state.activePreviewIdx && processSingleSlice(state.slicedImages[state.activePreviewIdx]);
    });
}

function handleFile(e) {
    if (!e.type.startsWith("image"))
        return alert("å›¾ç‰‡æ ¼å¼é”™è¯¯");
    state.fileName = e.name.replace(/\.[^/.]+$/, "");
    const t = new FileReader;
    t.onload = e => {
        $("#image").attr("src", e.target.result),
        $("#drop-zone").hide(),
        $("#editorContainer").show(),
        $("#btnReupload").show(),
        state.cropper && state.cropper.destroy(),
        state.cropper = new Cropper(document.getElementById("image"),{
            viewMode: 1,
            autoCropArea: .95,
            guides: !1,
            ready: () => {
                updateCropperGrid(),
                updateSquareDimDisplay()
            }
            ,
            cropend: () => {
                updateCropperGrid(),
                updateSquareDimDisplay()
            }
        })
    }
    ,
    t.readAsDataURL(e)
}

function updateCropperGrid() {
    if (!state.cropper)
        return;
    const e = $(".cropper-view-box");
    if (0 === e.length)
        return;
    const t = $("#checkShowGrid").is(":checked")
      , a = $("#inputGridColor").val()
      , n = parseInt($("#inputGridWeight").val()) || 1;
    $("#previewGrid").css({
        display: "grid",
        "grid-template-columns": `repeat(${state.cols}, 1fr)`,
        gap: "10px"
    }),
    $("#previewGrid > .col").css({
        width: "auto",
        flex: "none"
    }),
    t ? (e.addClass("show-grid"),
    e.css({
        "--grid-w": 100 / state.cols + "%",
        "--grid-h": 100 / state.rows + "%",
        "--line-w": n + "px",
        "--c": a
    })) : e.removeClass("show-grid")
}

function updateSquareDimDisplay() {
    if (state.cropper && state.cropper.ready)
        try {
            const e = state.cropper.getCropBoxData()
              , t = state.cropper.getCanvasData();
            if (!e || 0 === e.width || 0 === e.height)
                return void $("#squareDimDisplay").text("N/A");
            const a = document.getElementById("image").naturalWidth / t.width
              , n = e.width * a
              , o = e.height * a
              , s = Math.round(n / state.cols)
              , i = Math.round(o / state.rows);
            isNaN(s) || s <= 0 || isNaN(i) || i <= 0 ? $("#squareDimDisplay").text("N/A") : $("#squareDimDisplay").text(`${s} x ${i} px`)
        } catch (e) {
            console.error("Error updating dimension display:", e),
            $("#squareDimDisplay").text("N/A")
        }
    else
        $("#squareDimDisplay").text("N/A")
}

async function generateSlices() {
    if (!state.cropper)
        return alert(TEXT.error_no_img);
    $("#loadingOverlay").fadeIn(),
    setTimeout(async () => {
        try {
            if (state.sourceCanvas = state.cropper.getCroppedCanvas(),
            !state.sourceCanvas)
                throw new Error("Canvas Error");
            const e = state.sourceCanvas.width
              , t = state.sourceCanvas.height;
            state.baseSliceW = e / state.cols,
            state.baseSliceH = t / state.rows,
            state.tolerance = parseInt($("#inputTolerance").val()) || 30,
            state.slicedImages = [];
            for (let e = 0; e < state.rows; e++)
                for (let t = 0; t < state.cols; t++) {
                    const a = e * state.cols + t
                      , n = {
                        id: a,
                        r: e,
                        c: t,
                        offsetX: 0,
                        offsetY: 0,
                        scale: 1,
                        selected: !1,
                        name: `${state.fileName}_${pad(a + 1)}`,
                        w: state.baseSliceW,
                        h: state.baseSliceH
                    };
                    await processSingleSlice(n),
                    state.slicedImages.push(n)
                }
            renderPreview()
        } catch (e) {
            console.error(e),
            alert("å¤„ç†å‡ºé”™ï¼Œè¯·åˆ·æ–°é‡è¯•")
        } finally {
            $("#loadingOverlay").fadeOut()
        }
    }
    , 100)
}

async function processSingleSlice(e) {
    const t = state.baseSliceW
      , a = state.baseSliceH;
    let n = document.createElement("canvas");
    n.width = t,
    n.height = a;
    const o = n.getContext("2d");
    o.save(),
    o.translate(t / 2 + e.offsetX, a / 2 + e.offsetY),
    o.scale(e.scale, e.scale),
    o.translate(-t / 2, -a / 2);
    const s = e.c * t
      , i = e.r * a;
    if (o.drawImage(state.sourceCanvas, s, i, t, a, 0, 0, t, a),
    o.restore(),
    $("#checkRemoveBg").is(":checked")) {
        parseInt($("#inputTolerance").val());
        state.bgContiguous ? floodFillRemoveBg(n, state.targetColor, state.tolerance) : globalRemoveBg(n, state.targetColor, state.tolerance)
    }
    const l = $("#checkMakeSquare").is(":checked");
    if ($("#checkCustomSize").is(":checked")) {
        const e = parseInt($("#outputWidth").val()) || t
          , o = parseInt($("#outputHeight").val()) || a
          , s = document.createElement("canvas");
        s.width = e,
        s.height = o,
        s.getContext("2d").drawImage(n, 0, 0, e, o),
        n = s
    } else if (l) {
        const e = Math.ceil(Math.max(t, a))
          , o = document.createElement("canvas");
        o.width = e,
        o.height = e;
        const s = (e - t) / 2
          , i = (e - a) / 2;
        o.getContext("2d").drawImage(n, s, i),
        n = o
    }
    return new Promise(t => {
        e.url && URL.revokeObjectURL(e.url);
        const a = $("#formatSelect").val()
          , o = parseFloat($("#qualityInput").val()) || .92;
        n.toBlob(o => {
            if (e.blob = o,
            e.url = URL.createObjectURL(o),
            e.ext = a.includes("webp") ? ".webp" : ".png",
            state.activePreviewIdx === e.id) {
                $("#slicePreviewImg").attr("src", e.url),
                $("#modalOrigDim").text(`${Math.round(state.baseSliceW)} x ${Math.round(state.baseSliceH)}`),
                $("#modalCurrDim").text(`${n.width} x ${n.height}`);
                const t = (o.size / 1024).toFixed(1);
                $("#modalFileSize").text(t)
            }
            t()
        }
        , a, o)
    }
    )
}

function globalRemoveBg(e, t, a) {
    const n = e.getContext("2d")
      , o = e.width
      , s = e.height;
    if (0 === o || 0 === s)
        return;
    const i = n.getImageData(0, 0, o, s)
      , l = i.data
      , c = a / 100 * 441.67
      , r = c * c
      , d = t.r
      , u = t.g
      , g = t.b;
    for (let e = 0; e < l.length; e += 4) {
        if (0 === l[e + 3])
            continue;
        const t = l[e]
          , a = l[e + 1]
          , n = l[e + 2];
        (t - d) * (t - d) + (a - u) * (a - u) + (n - g) * (n - g) <= r && (l[e + 3] = 0)
    }
    n.putImageData(i, 0, 0)
}

function floodFillRemoveBg(e, t, a) {
    const n = e.getContext("2d")
      , o = e.width
      , s = e.height;
    if (0 === o || 0 === s)
        return;
    const i = n.getImageData(0, 0, o, s)
      , l = i.data
      , c = new Uint8Array(o * s)
      , r = []
      , d = a / 100 * 441.67
      , u = d * d
      , g = t.r
      , p = t.g
      , m = t.b
      , h = (e, t) => {
        if (e < 0 || e >= o || t < 0 || t >= s)
            return;
        const a = t * o + e;
        c[a] || ((e => {
            const t = 4 * e
              , a = l[t]
              , n = l[t + 1]
              , o = l[t + 2];
            return (a - g) * (a - g) + (n - p) * (n - p) + (o - m) * (o - m) <= u
        }
        )(a) ? (l[4 * a + 3] = 0,
        c[a] = 1,
        r.push(a)) : c[a] = 1)
    }
    ;
    for (let e = 0; e < o; e++)
        h(e, 0),
        h(e, s - 1);
    for (let e = 1; e < s - 1; e++)
        h(0, e),
        h(o - 1, e);
    for (; r.length > 0; ) {
        const e = r.pop()
          , t = e % o
          , a = Math.floor(e / o);
        h(t + 1, a),
        h(t - 1, a),
        h(t, a + 1),
        h(t, a - 1)
    }
    n.putImageData(i, 0, 0)
}

function renderPreview() {
    const e = $("#previewGrid");
    e.empty(),
    $("#resultCount").text(state.slicedImages.length),
    $("#resultSection").slideDown(),
    state.slicedImages.forEach( (t, a) => {
        const n = $(`
            <div class="col">
                <div class="slice-card ${t.selected ? "selected" : ""}" data-idx="${a}" onclick="toggleSelect(${a})">
                    <div class="check-mark"><i class="bi bi-check"></i></div>
                    
                    <div class="nudge-tools mt-1" onclick="event.stopPropagation()" style="display: flex; flex-direction: column; align-items: center; gap: 4px;">
                        <div class="d-flex align-items-center">
                            <button class="btn-preview-slice" onclick="openPreviewModal(${a})" title="é¢„è§ˆä¸å¾®è°ƒ"><i class="bi bi-eye"></i></button>
                            
                            <div class="btn-group btn-group-sm" role="group">
                                <button class="btn-nudge" onclick="zoom(${a}, -0.05)" title="ç¼©å°åˆ‡ç‰‡å†…å®¹"><i class="bi bi-dash-lg"></i></button>
                                <button class="btn-nudge" onclick="nudge(${a}, -2, 0)" title="å·¦ç§»">â†</button>
                                <button class="btn-nudge" onclick="nudge(${a}, 0, -2)" title="ä¸Šç§»">â†‘</button>
                                <button class="btn-nudge" onclick="smartCenter(${a})" title="è‡ªåŠ¨å±…ä¸­" style="color:var(--primary-color)"><i class="bi bi-bullseye"></i></button>
                                <button class="btn-nudge" onclick="nudge(${a}, 0, 2)" title="ä¸‹ç§»">â†“</button>
                                <button class="btn-nudge" onclick="nudge(${a}, 2, 0)" title="å³ç§»">â†’</button>
                                <button class="btn-nudge" onclick="zoom(${a}, 0.05)" title="æ”¾å¤§åˆ‡ç‰‡å†…å®¹"><i class="bi bi-plus-lg"></i></button>
                            </div>
                        </div>
                    </div>

                    <div class="slice-img-wrapper"><img src="${t.url}"></div>
                    <button class="btn-single-dl" onclick="downloadSingle(event, ${a})"><i class="bi bi-download"></i></button>
                    <input type="text" class="form-control form-control-sm name-input" value="${t.name}" onclick="event.stopPropagation()">
                </div>
            </div>`);
        e.append(n)
    }
    ),
    $(".name-input").on("change", function() {
        const e = $(this).closest(".slice-card").data("idx");
        state.slicedImages[e].name = $(this).val()
    }),
    $("html, body").animate({
        scrollTop: $("#resultSection").offset().top - 80
    }, 500),
    updateDownloadBtnText()
}

function toggleSelect(e) {
    const t = state.slicedImages[e];
    t.selected = !t.selected;
    const a = $(`.slice-card[data-idx="${e}"]`);
    t.selected ? a.addClass("selected") : a.removeClass("selected"),
    updateDownloadBtnText()
}

function toggleSelectAll() {
    const e = state.slicedImages.every(e => e.selected);
    state.slicedImages.forEach( (t, a) => {
        t.selected = !e;
        const n = $(`.slice-card[data-idx="${a}"]`);
        t.selected ? n.addClass("selected") : n.removeClass("selected")
    }
    ),
    updateDownloadBtnText()
}

function updateDownloadBtnText() {
    const e = state.slicedImages.filter(e => e.selected).length
      , a = $("#btnDownloadZip span");
    e > 0 ? a.text(`${TEXT.msg_selected_dl} (${e})`) : a.text(TEXT.btn_download_zip)
}

function downloadSingle(e, t) {
    e.stopPropagation();
    const a = state.slicedImages[t]
      , n = $(`.slice-card[data-idx="${t}"] .name-input`).val();
    saveAs(a.blob, n + a.ext)
}

function downloadZip() {
    if (0 === state.slicedImages.length)
        return;
    $(".name-input").each(function() {
        const e = $(this).closest(".slice-card").data("idx");
        state.slicedImages[e].name = $(this).val()
    });
    const e = new JSZip
      , t = e.folder("stickers")
      , a = state.slicedImages.filter(e => e.selected);
    (a.length > 0 ? a : state.slicedImages).forEach(e => {
        let a = e.name;
        a.toLowerCase().endsWith(e.ext) || (a += e.ext),
        t.file(a, e.blob)
    }
    );
    const n = $("#btnDownloadZip")
      , o = n.html();
    n.prop("disabled", !0).html('<i class="bi bi-hourglass-split"></i> ' + TEXT.zip_generating),
    e.generateAsync({
        type: "blob"
    }).then(function(e) {
        saveAs(e, `${state.fileName}_pack.zip`),
        n.prop("disabled", !1).html(o)
    })
}

function pad(e) {
    return e.toString().padStart(2, "0")
}

$(document).ready(function() {
    injectCustomDOM(),
    initUI(),
    bindEvents(),
    changeTheme(state.theme)
}),
window.nudge = async function(e, t, a) {
    const n = state.slicedImages[e];
    n.offsetX += t,
    n.offsetY += a,
    $(`.slice-card[data-idx="${e}"] img`).css("opacity", .5),
    await processSingleSlice(n),
    $(`.slice-card[data-idx="${e}"] img`).attr("src", n.url).css("opacity", 1)
}
,
window.smartCenter = async function(e) {
    const t = state.slicedImages[e]
      , a = state.baseSliceW
      , n = state.baseSliceH
      , o = document.createElement("canvas");
    o.width = a,
    o.height = n;
    const s = o.getContext("2d")
      , i = t.c * a
      , l = t.r * n;
    s.drawImage(state.sourceCanvas, i, l, a, n, 0, 0, a, n),
    $("#checkRemoveBg").is(":checked") && floodFillRemoveBg(o, state.targetColor, state.tolerance);
    const c = s.getImageData(0, 0, a, n).data;
    let r = a
      , d = n
      , u = 0
      , g = 0
      , p = !1;
    for (let e = 0; e < n; e++)
        for (let t = 0; t < a; t++) {
            c[4 * (e * a + t) + 3] > 0 && (t < r && (r = t),
            t > u && (u = t),
            e < d && (d = e),
            e > g && (g = e),
            p = !0)
        }
    if (!p)
        return;
    const m = r + (u - r) / 2
      , h = d + (g - d) / 2
      , b = a / 2
      , v = n / 2;
    t.offsetX = b - m,
    t.offsetY = v - h,
    $(`.slice-card[data-idx="${e}"] img`).css("opacity", .5),
    await processSingleSlice(t),
    $(`.slice-card[data-idx="${e}"] img`).attr("src", t.url).css("opacity", 1)
}
,
window.zoom = async function(e, t) {
    const a = state.slicedImages[e];
    a.scale += t,
    a.scale < .1 && (a.scale = .1),
    a.scale > 3 && (a.scale = 3),
    $(`.slice-card[data-idx="${e}"] img`).css("opacity", .5),
    await processSingleSlice(a),
    $(`.slice-card[data-idx="${e}"] img`).attr("src", a.url).css("opacity", 1)
}
,
window.openPreviewModal = function(e) {
    state.activePreviewIdx = e;
    const t = state.slicedImages[e];
    viewScale = 1,
    $("#slicePreviewImg").attr("src", t.url).css("transform", `scale(${viewScale})`),
    $("#inputViewZoom").val(100),
    $("#modalToleranceInput").val(state.tolerance),
    $("#modalToleranceVal").val(state.tolerance),
    $("#modalContiguousInput").prop("checked", state.bgContiguous),
    processSingleSlice(t);
    const a = `
        <div class="btn-group shadow" role="group">
            <button class="btn btn-dark btn-sm border-secondary" onclick="zoom(${e}, -0.05)" title="ç¼©å°åˆ‡ç‰‡å†…å®¹"><i class="bi bi-dash"></i></button>
            <button class="btn btn-dark btn-sm border-secondary" onclick="nudge(${e}, -2, 0)" title="å·¦ç§»">â†</button>
            <button class="btn btn-dark btn-sm border-secondary" onclick="nudge(${e}, 0, -2)" title="ä¸Šç§»">â†‘</button>
            <button class="btn btn-primary btn-sm border-secondary" onclick="smartCenter(${e})" title="è‡ªåŠ¨å±…ä¸­"><i class="bi bi-bullseye"></i></button>
            <button class="btn btn-dark btn-sm border-secondary" onclick="nudge(${e}, 0, 2)" title="ä¸‹ç§»">â†“</button>
            <button class="btn btn-dark btn-sm border-secondary" onclick="nudge(${e}, 2, 0)" title="å³ç§»">â†’</button>
            <button class="btn btn-dark btn-sm border-secondary" onclick="zoom(${e}, 0.05)" title="æ”¾å¤§åˆ‡ç‰‡å†…å®¹"><i class="bi bi-plus"></i></button>
        </div>
    `;
    $("#modalNudgeTools").html(a);
    new bootstrap.Modal(document.getElementById("slicePreviewModal")).show(),
    $("#slicePreviewModal").on("hidden.bs.modal", function() {
        state.activePreviewIdx = -1
    })
}
;

</script>
</body>
</html>